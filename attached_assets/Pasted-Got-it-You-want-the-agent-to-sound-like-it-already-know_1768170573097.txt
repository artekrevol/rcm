Got it. You want the agent to sound like it already “knows” the lead (name, source, service interest, state, maybe insurance carrier) **before** it starts talking — so the call is more human, less robotic, and higher-converting.

Below is exactly what to change in **Replit** (backend + DB + UI flow) and the **Vapi assistant config** so every outbound call is created with a **lead context payload** (aka dynamic variables).

---

## Goal (what “good” looks like)

When you click **Call with AI**, Vapi should receive:

* `lead.firstName`, `lead.lastName`
* `lead.preferredName` (optional)
* `lead.phone`
* `lead.state`
* `lead.serviceNeeded` (detox/residential/IOP/outpatient/unknown)
* `lead.source` (website/referral/phone/etc.)
* `lead.lastOutcome` + `lead.attempts`
* `lead.bestTimeToCall` (if known)
* `lead.notes` (if internal)
* `clinic.name` + `clinic.callbackNumber`
* compliance flags like `recordingDisclosureRequired`

Then the agent opens like:

> “Hi **Abeer**, this is Riley from Kemah Palms Recovery. You reached out on our website about **outpatient** services…”

That’s the win.

---

# A) Replit changes (what to implement)

## 1) Add / confirm lead fields in DB (Drizzle + Postgres)

Make sure your `leads` table has these fields (or equivalents):

**Must-have**

* `id`
* `firstName`
* `lastName`
* `phone`
* `source`
* `state`
* `serviceNeeded`

**Strong ROI**

* `preferredName`
* `bestTimeToCall`
* `attempts` (int)
* `lastOutcome` (enum)
* `notes` (text)
* `consentToCall` (bool) — even if default true for demo
* `timezone` (optional)

**Change**

* Update your Drizzle schema to include these
* Run migration

**Why**
Because you can’t personalize unless the data exists and is consistent.

---

## 2) Create a “Call Payload Builder” function (Backend)

In your backend (Express), build a single function that converts a lead record into a Vapi-ready payload.

Example structure you want to generate:

```json
{
  "assistantId": "YOUR_ASSISTANT_ID",
  "phoneNumberId": "YOUR_VAPI_NUMBER_ID",
  "customer": { "number": "+14158865867" },
  "metadata": { "leadId": "abc123" },
  "assistantOverrides": {
    "variableValues": {
      "patient_first_name": "Abeer",
      "patient_last_name": "Raza",
      "patient_preferred_name": "Abeer",
      "patient_state": "TX",
      "patient_source": "Website",
      "service_needed": "Outpatient",
      "attempts": "2",
      "last_outcome": "Needs_follow_up",
      "best_time_to_call": "2–4 PM",
      "clinic_name": "Kemah Palms Recovery",
      "clinic_callback_number": "(xxx) xxx-xxxx"
    }
  }
}
```

**What to change**

* Create a function: `buildVapiCallPayload(lead)`
* This function:

  * normalizes phone to E.164
  * fills blanks with “Unknown”
  * formats service names nicely (IOP → “intensive outpatient”)

---

## 3) Create an endpoint: `POST /api/leads/:id/call`

This endpoint is triggered from your UI “Call with AI” button.

**What it does**

1. Fetch lead by ID
2. Create a call in Vapi using the payload above
3. Save call record in DB:

   * `leadId`
   * `vapiCallId`
   * status = `queued`
   * payload snapshot (optional but powerful for debugging)
4. Return call status to the frontend

**Why**
This makes the call creation deterministic and traceable.

---

## 4) Frontend: pass the right lead + show a “Call prep preview”

When you click “Call with AI”, show a small modal:

**“Agent will use:”**

* Name: Abeer Raza
* State: TX
* Service: Outpatient
* Source: Website
* Attempts: 2
* Last Outcome: Needs follow-up

Buttons:

* **Start Call**
* Cancel

**Why**
This forces your data hygiene and prevents “Unknown Unknown” calls.

---

# B) Vapi changes (assistant prompt + variable injection)

Vapi needs two things:

1. A way to receive variables (`variableValues`)
2. A prompt that actually uses them naturally

---

## 1) Add variables to the prompt (System Prompt)

In your Vapi assistant prompt, add a section:

### “Lead Context (Variables)”

Tell the model these values exist and how to use them.

Example (clean + strong):

* If `patient_preferred_name` exists, use it once early.
* If only `patient_first_name`, use that.
* If no name, ask politely early.
* If `service_needed` is known, reference it.
* If `source` is known, reference it.

This reduces robotic repetition because it anchors the conversation.

---

## 2) Make the intro dynamic and non-robotic

Instead of one rigid intro, use conditional phrasing.

**Logic:**

* If you know name + service → personalize immediately
* If you only know name → personalize + ask service
* If you know nothing → neutral intro

Your prompt should explicitly instruct the agent to vary phrasing:

* “Hey {name}…”
* “Hi {name}, quick follow-up…”
* “Hi, is this {name}?”

---

## 3) Use “Do not re-ask known facts”

Add a rule:

> If the lead context already includes state/service/source, do not ask it again unless needed to confirm.

This is a huge “less robotic” fix.

---

# C) Exactly what you’ll implement today (highest ROI in 1–2 hours)

### ✅ Step 1: DB fields

Add `preferredName`, `serviceNeeded`, `state`, `source` if missing.

### ✅ Step 2: Backend call endpoint

`POST /api/leads/:id/call` builds payload + calls Vapi.

### ✅ Step 3: Inject `assistantOverrides.variableValues`

Send lead details into Vapi.

### ✅ Step 4: Update Vapi prompt to use variables

And stop repeating questions.

That’s enough to drastically improve call quality **this week**.

---

# D) What else can be shared (safely) before the call

You can also pass:

* previous attempt outcomes (“No answer last time”)
* best callback window
* referral type (physician/referral/website)
* high priority flag (P0 SLA breach)
* a short internal note: “Caller sounded anxious, wants detox”

**But do NOT pass** anything that would sound creepy if repeated:

* too many internal notes
* marketing tags
* “high value lead” etc.

---

# E) Quick checklist (so you know it’s working)

After changes, test with one lead:

* Start call
* In Vapi logs, confirm `variableValues` show up
* In transcript, confirm first line says the lead’s name + service/source
* Confirm it doesn’t ask “what state are you in?” if state was already passed

---

If you paste your current backend route for “Call with AI” (even a snippet), I can rewrite it into the exact payload shape your Vapi account expects — but even without that, the steps above are the correct implementation pattern.
